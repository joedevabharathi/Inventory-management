{% extends 'base.html' %}
{% block content %}
<div class="products-page">
    <div class="page-header">
        <h2><i class="fas fa-boxes"></i> Products Management</h2>
        <button class="btn-primary" onclick="openAddProductModal()">
            <i class="fas fa-plus"></i> Add New Product
        </button>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addProductModal')">&times;</span>
            <h3>Add New Product</h3>

            <form method="POST" action="{{ url_for('add_product') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="form-group">
                    <label>Generated Product ID (Auto â€” Not Saved to DB)</label>
                    <input type="text" id="autoProductId" readonly style="background-color:#eee; cursor:not-allowed;">
                </div>

                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" name="name" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" name="quantity" min="0" required>
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <select name="location_id" required>
                        <option value="">Select Location</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}">{{ loc.branch_name }} ({{ loc.city }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Product Image</label>
                    <input type="file" name="image" accept="image/*">
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editProductModal')">&times;</span>
            <h3>Edit Product</h3>
            <form id="editProductForm" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="edit-id" name="id">

                <div class="form-group">
                    <label>Product ID (readonly)</label>
                    <input type="text" id="edit-product_code" name="product_code" readonly
                           style="background-color:#eee; cursor:not-allowed;">
                </div>

                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-name" name="name" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea id="edit-description" name="description" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" id="edit-quantity" name="quantity" required min="0">
                </div>

                <div class="form-group">
                    <label>Location</label>
                    <select id="edit-location" name="location_id" required>
                        {% for location in locations %}
                        <option value="{{ location.id }}">{{ location.branch_name }} ({{ location.city }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('editProductModal')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn-primary save-edit-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Table -->
    <div class="table-responsive">
        <table id="productTable">
            <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Quantity</th>
                    <th>Location</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for p in products %}
                <tr id="product-{{ p.id }}">
                    <td class="p-code">PRD{{ '%04d'|format(p.id) }}</td>
                    <td class="p-name">{{ p.name }}</td>
                    <td class="p-desc">{{ p.description or 'No description' }}</td>
                    <td class="p-qty">{{ p.quantity }}</td>
                    <td class="p-loc">{{ p.location_name }} ({{ p.location_city if p.location_city else 'Unknown' }})</td>
                    <td class="actions">
                        <button type="button" class="btn-edit" data-product='{{ p|tojson|safe }}'>
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <a href="{{ url_for('delete_product', id=p.id) }}" class="btn-delete"
                           onclick="return confirm('Are you sure you want to delete this product?')">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Script to auto-generate random Product ID -->
<script>
function openAddProductModal() {
    const modal = document.getElementById('addProductModal');
    modal.style.display = 'block';
    document.getElementById('autoProductId').value = generateRandomProductId();
}

function generateRandomProductId() {
    const randomPart = Math.floor(Math.random() * 90000) + 10000; // 5-digit random number
    const datePart = new Date().getTime().toString().slice(-6);  // last 6 digits of timestamp
    return "PRD-" + datePart + "-" + randomPart;
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// Fill Edit Modal with Data
document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', () => {
        const product = JSON.parse(btn.dataset.product);
        document.getElementById('edit-id').value = product.id;
        document.getElementById('edit-product_code').value = "PRD-" + String(product.id).padStart(4, '0');
        document.getElementById('edit-name').value = product.name;
        document.getElementById('edit-description').value = product.description || '';
        document.getElementById('edit-quantity').value = product.quantity;
        document.getElementById('edit-location').value = product.location_id;
        document.getElementById('editProductForm').action = `/update_product/${product.id}`;
        document.getElementById('editProductModal').style.display = 'block';
    });
});
</script>
{% endblock %}
